# JDK 8 G1GC Full GC 회피 벤치마크 분석 리포트

**테스트 일시**: 2026-01-05
**테스트 환경**: OpenJDK 1.8.0_432, G1GC, 힙 2GB
**목적**: Full GC 없이 안전하게 처리 가능한 최대 트래픽 수준 측정

---

## 목차

1. [테스트 결과 요약](#1-테스트-결과-요약)
2. [상세 분석](#2-상세-분석)
3. [JDK 8 G1GC 특성 및 문제점](#3-jdk-8-g1gc-특성-및-문제점)
4. [운영 환경 적용 가이드](#4-운영-환경-적용-가이드)
5. [G1GC vs Parallel GC 비교](#5-g1gc-vs-parallel-gc-비교)
6. [권장사항](#6-권장사항)

---

## 1. 테스트 결과 요약

### 1.1 핵심 결론

```
┌──────────────────────────────────────────────────┐
│  최대 안전 동시접속: 25개                        │
│  권장 운영 동시접속: 20개 (80% 마진 적용)        │
│  달성 TPS: 114.60 req/s                         │
│  Full GC 발생: 0회                              │
└──────────────────────────────────────────────────┘
```

### 1.2 상세 측정 데이터

| 동시접속 | TPS | 평균(ms) | P99(ms) | Max(ms) | 힙(%) | Old GC | 상태 |
|---------|-----|---------|---------|---------|-------|--------|------|
| 5 | 56.40 | 51 | 89 | 116 | 35% | 0 | OK |
| 10 | 75.10 | 73 | 113 | 139 | 47% | 0 | OK |
| 15 | 87.20 | 98 | 171 | 248 | 63% | 0 | OK |
| 20 | 90.95 | 125 | 286 | 467 | 67% | 0 | OK |
| 25 | 114.60 | 124 | 306 | 458 | 78% | 0 | **경고** |
| 30 | 116.65 | 149 | 332 | 449 | 91% | 0 | **중단** |

### 1.3 GC 통계

```
Young GC: 23회, 총 899ms (평균 39ms/회)
Old GC: 0회 (Full GC 없음!)
```

---

## 2. 상세 분석

### 2.1 TPS 분석

```
동시접속 증가에 따른 TPS 변화:
5개  → 56.40 req/s
10개 → 75.10 req/s (+33%)
15개 → 87.20 req/s (+16%)
20개 → 90.95 req/s (+4%)   ← TPS 증가율 둔화 시작
25개 → 114.60 req/s (+26%)
30개 → 116.65 req/s (+2%)  ← 포화 상태
```

**분석 결과**:
- 동시접속 20개까지는 TPS가 선형에 가깝게 증가
- 동시접속 25개 이상에서 TPS 증가율 급감 (포화 징후)
- 동시접속 30개에서 실질적인 TPS 증가 없음 → 시스템 한계 도달

### 2.2 응답시간 분석

```
P99 응답시간 추이:
동시접속 5개  → P99 89ms   (목표 200ms 이내)
동시접속 10개 → P99 113ms  (목표 이내)
동시접속 15개 → P99 171ms  (목표 이내)
동시접속 20개 → P99 286ms  (목표 초과!)
동시접속 25개 → P99 306ms  (목표 초과)
동시접속 30개 → P99 332ms  (목표 초과)
```

**분석 결과**:
- `MaxGCPauseMillis=200ms` 설정에도 불구하고 동시접속 20개부터 P99가 200ms 초과
- 이는 G1GC의 pause time 예측 실패를 의미
- 부하 증가 시 G1이 목표 pause time을 맞추지 못함

#### 왜 P99가 MaxGCPauseMillis(200ms)를 초과하는가?

G1GC의 `MaxGCPauseMillis`는 **목표값**이지 **보장값이 아님**:

1. **예측 기반 동작**: G1은 과거 GC 데이터를 기반으로 다음 GC를 예측
2. **예측 실패**: 부하가 급변하면 예측 모델이 틀림
3. **부하 증가 시**:
   - Live 객체 증가 → 복사할 객체 증가
   - Region 수 증가 → 처리 시간 증가
   - 힙 압박 → 더 자주, 더 오래 GC

### 2.3 힙 사용률 분석

```
힙 사용률 추이 (최대 2GB):
동시접속 5개  → 35% (0.70GB)
동시접속 10개 → 47% (0.94GB)
동시접속 15개 → 63% (1.26GB)
동시접속 20개 → 67% (1.34GB)
동시접속 25개 → 78% (1.56GB) ← 경고 (70% 초과)
동시접속 30개 → 91% (1.82GB) ← 위험 (85% 초과)
```

**분석 결과**:
- 동시접속 25개에서 힙 78% 사용 → Full GC 임박 경고
- 동시접속 30개에서 힙 91% → Full GC 발생 직전 상태
- 2GB 힙으로는 동시접속 25개가 한계

---

## 3. JDK 8 G1GC 특성 및 문제점

### 3.1 JDK 8 G1GC의 핵심 문제점

#### 문제 1: Full GC가 Single-Threaded

```
JDK 8:  Full GC → 단일 스레드 (Serial Old GC 사용)
JDK 9+: Full GC → 멀티 스레드 (Parallel Full GC)
```

**영향**:
- 힙 8GB 기준 Full GC 시 **수 초 ~ 수십 초** STW
- P99 latency 급등
- 서비스 장애 수준의 지연

#### 문제 2: String Deduplication 미성숙

```java
// JDK 8: -XX:+UseStringDeduplication 있지만 버그 多
// JDK 9+: 안정화됨
```

- 메모리 절약 효과 불안정
- 오히려 GC 오버헤드 증가하는 경우 있음
- **JDK 8에서는 사용 비권장**

#### 문제 3: Humongous Object 처리 비효율

```
Humongous Object = Region 크기의 50% 이상인 객체

JDK 8 문제점:
- Humongous 객체가 Old Gen에 직접 할당
- Young GC에서 회수 불가
- Full GC에서만 회수 → Full GC 유발 원인
```

#### 문제 4: Mixed GC 효율성 부족

```
Mixed GC = Young + 일부 Old Region 수집

JDK 8 문제:
- Old Region 선택 알고리즘 미성숙
- 불필요한 Region까지 수집 → pause time 증가
- Remark 단계에서 병목
```

#### 문제 5: Remembered Set (RSet) 오버헤드

```
RSet = Region 간 참조를 추적하는 자료구조

JDK 8:
- RSet 메모리 오버헤드 큼 (힙의 ~5-20%)
- RSet 갱신 비용 높음
- Concurrent Refinement 스레드 경합
```

#### 문제 6: IHOP 고정값 문제

```java
// JDK 8 기본값
-XX:InitiatingHeapOccupancyPercent=45  // 고정값

// JDK 9+
Adaptive IHOP 도입 → 자동 조절
```

- 고정된 IHOP로 인해 상황에 맞지 않는 타이밍에 Concurrent Marking 시작
- 너무 빨리 시작 → CPU 낭비
- 너무 늦게 시작 → Full GC 발생

#### 문제 7: Class Unloading 성능

```
JDK 8:
- Concurrent Marking 중 클래스 언로딩 불가
- Full GC에서만 클래스 언로딩
- 동적 클래스 로딩 많은 앱에서 문제

JDK 12+:
- Concurrent Class Unloading 지원
```

### 3.2 JDK 버전별 G1GC 개선사항

| 버전 | 개선 내용 |
|------|----------|
| JDK 9 | Parallel Full GC, Adaptive IHOP |
| JDK 10 | Full GC 병렬화 완료 |
| JDK 11 | Abort 가능한 Mixed GC |
| JDK 12 | Concurrent Class Unloading |
| JDK 13 | 힙 반환 개선 |
| JDK 14+ | NUMA 지원 개선 |

**결론**: 가능하면 **JDK 11+ 사용 권장**. JDK 8 필수 시 튜닝 필수.

---

## 4. 운영 환경 적용 가이드

### 4.1 실제 운영 환경 분석: 200 TPS, 8GB Heap, 2 Pod

#### 환경 계산

```
총 TPS: 200
Pod 수: 2개
Pod당 TPS: 100 TPS
Pod당 Heap: 8GB
```

#### 테스트 결과 기반 추정

```
우리 테스트 (2GB Heap):
- ~90 TPS  → 힙 67% (1.34GB 사용)
- ~115 TPS → 힙 78% (1.56GB 사용)

8GB Heap으로 환산:
- 100 TPS 기준 예상 힙 사용량:
- 2GB 힙에서 ~1.4GB 사용 (70%)
- 8GB 힙에서 ~1.4GB 사용 → 약 17.5%
```

#### 판단

| 항목 | 2GB Heap | 8GB Heap | 판정 |
|------|----------|----------|------|
| 100 TPS 힙 사용률 | ~70% | ~17% | **여유** |
| Full GC 위험 | 높음 | **낮음** | OK |
| GC 오버헤드 | 높음 | 낮음 | OK |
| 버퍼 | 거의 없음 | **충분** | OK |

#### 결론: **적절함** ✅

```
┌─────────────────────────────────────────────────┐
│  8GB Heap + 100 TPS/Pod = 안전                 │
│  예상 힙 사용률: 15-25%                        │
│  Full GC 위험: 낮음                            │
│  트래픽 3-4배 버스트도 버틸 여유 있음          │
└─────────────────────────────────────────────────┘
```

#### 트래픽 스파이크 대비

```
현재: 100 TPS/Pod (힙 ~20%)
2배 스파이크: 200 TPS/Pod (힙 ~40%) → OK
4배 스파이크: 400 TPS/Pod (힙 ~80%) → 위험
```

### 4.2 권장 JVM 설정 (8GB Heap)

```bash
# 기본 설정
-Xms8g -Xmx8g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:G1HeapRegionSize=16m

# Full GC 방지 튜닝
-XX:InitiatingHeapOccupancyPercent=35  # 여유있게 일찍 Marking 시작
-XX:G1ReservePercent=15                # 예비 공간 확보

# GC 스레드 설정
-XX:ParallelGCThreads=8                # STW 단계 (CPU 코어 수)
-XX:ConcGCThreads=2                    # Concurrent 단계

# GC 로깅 (JDK 8)
-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
-XX:+PrintGCTimeStamps
-Xloggc:/var/log/gc.log
```

### 4.3 힙 크기별 예상 처리량

| 힙 크기 | 예상 안전 동시접속 | 예상 TPS |
|---------|-------------------|----------|
| 2GB | 20개 | ~90 req/s |
| 4GB | 40개 | ~180 req/s |
| 8GB | 80개 | ~360 req/s |

### 4.4 모니터링 알람 기준

| 지표 | 정상 | 경고 | 위험 |
|------|------|------|------|
| 힙 사용률 | <50% | 50-70% | >70% |
| Old GC 횟수 | 0 | 1+ | - |
| P99 응답시간 | <100ms | 100-200ms | >200ms |
| Young GC 빈도 | 안정적 | 급증 | - |

---

## 5. G1GC vs Parallel GC 비교

### 5.1 설계 철학 차이

```
┌─────────────────────────────────────────────────────────────┐
│ Parallel GC 설계 철학                                       │
├─────────────────────────────────────────────────────────────┤
│ - Full GC는 피할 대상이 아님                                │
│ - Full GC도 병렬로 빠르게 처리                              │
│ - Throughput(처리량) 최적화가 목표                          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ G1GC 설계 철학                                              │
├─────────────────────────────────────────────────────────────┤
│ - Full GC는 피해야 할 대상                                  │
│ - Incremental Mixed GC로 조금씩 수집                        │
│ - Latency(지연시간) 최적화가 목표                           │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 Full GC 특성 비교

| 항목 | G1GC (JDK 8) | Parallel GC |
|------|--------------|-------------|
| Full GC 발생 | 피하려고 노력 | **정상 동작의 일부** |
| Full GC 스레드 | **Single-thread** ⚠️ | **Multi-thread** ✅ |
| Full GC 빈도 | 낮음 (잘 튜닝 시) | 높음 |
| Full GC 속도 | 매우 느림 | 상대적으로 빠름 |
| 8GB 힙 Full GC | 2-10초 ⚠️ | 200-500ms |

### 5.3 같은 환경 (8GB Heap, 100 TPS) 비교

```
┌─────────────────────────────────────────────────────────────┐
│ Parallel GC 예상                                            │
├─────────────────────────────────────────────────────────────┤
│ Minor GC: 자주 발생 (수십ms, 병렬)                          │
│ Full GC: 가끔 발생 (200-500ms, 병렬)                        │
│ P99: 100-300ms (Full GC 포함)                               │
│ Throughput: 높음 ✅                                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ G1GC (JDK 8) 예상                                           │
├─────────────────────────────────────────────────────────────┤
│ Young GC: 자주 발생 (20-50ms, 병렬)                         │
│ Mixed GC: 가끔 발생 (수십~백ms)                             │
│ Full GC: 없음 (힙 20% 사용으로 안전)                        │
│ P99: 50-100ms ✅                                            │
│ Throughput: 약간 낮음                                       │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 선택 기준

| 상황 | 권장 GC | 이유 |
|------|---------|------|
| **P99 중요** (API 서버) | G1GC | Full GC 회피로 지연시간 안정 |
| **Throughput 중요** (배치) | Parallel GC | 처리량 최적화 |
| **JDK 8 필수 + 저지연** | G1GC + 힙 여유있게 | Full GC만 안 나면 G1 우위 |
| **JDK 11+** | G1GC | Full GC도 병렬로 개선됨 |

### 5.5 결론

```
Q: 8GB Heap, 100 TPS 환경에서 어떤 GC?

A: G1GC 권장 ✅

이유:
- 힙 사용률 ~20%로 Full GC 위험 없음
- Full GC 없이 운영 시 G1이 P99 우위
- Parallel GC는 Full GC가 "정상"이라 P99 불안정
```

---

## 6. 권장사항

### 6.1 운영 환경 권장 설정

| 항목 | 권장값 | 근거 |
|------|--------|------|
| 최대 동시접속 | **20개** | 힙 67%, P99 286ms |
| 안전 동시접속 | **15개** | 힙 63%, P99 171ms |
| 힙 크기 | **4GB 이상** | 여유 공간 확보 |

### 6.2 JDK 8 G1GC 운영 체크리스트

```
□ 힙 크기 충분한가? (권장 4GB+)
□ Full GC 발생하지 않는가?
□ IHOP 적절한가? (Full GC 발생 시 낮추기)
□ Humongous 객체 발생하는가? (Region 크기 조정)
□ P99 latency 목표 내인가?
□ GC 로그 모니터링 설정했는가?
□ 힙 사용률 70% 이하 유지하는가?
```

### 6.3 핵심 교훈

```
JDK 8 G1GC 운영 시 핵심 원칙:

1. Full GC는 절대 발생시키지 않는다
   → JDK 8 Full GC는 단일 스레드, 수 초 STW

2. 힙 사용률 70% 이하 유지
   → 버퍼 확보로 Full GC 예방

3. MaxGCPauseMillis는 목표일 뿐, 믿지 않는다
   → 부하 증가 시 예측 실패

4. P99를 기준으로 용량 산정
   → 평균이 아닌 P99 기준 SLA 설정

5. 가능하면 JDK 11+ 업그레이드
   → Full GC 병렬화로 위험 감소
```

---

## 부록

### A. 테스트 환경

```
JVM: OpenJDK 1.8.0_432 (Temurin)
GC: G1GC
힙: -Xms2g -Xmx2g
G1 설정:
  -XX:MaxGCPauseMillis=200
  -XX:G1HeapRegionSize=16m
  -XX:InitiatingHeapOccupancyPercent=45
  -XX:G1ReservePercent=10

워크로드: /allocate (1-5KB 객체 10-50개 할당)
테스트 시간: 단계별 20초
CPU: 10 cores
```

### B. 테스트 종료 기준

| 기준 | 값 | 설명 |
|------|-----|------|
| Old Gen GC 발생 | 즉시 중단 | Full GC 감지 |
| 힙 사용률 | 85% 이상 | Full GC 임박 |
| 힙 사용률 경고 | 70% 이상 | 경고 표시 |

### C. 원본 데이터

```csv
Concurrency,TPS,AvgResponseTime(ms),P99ResponseTime(ms),MaxResponseTime(ms),HeapUsage(%),OldGCCount,Status
5,56.40,51,89,116,35,0,OK
10,75.10,73,113,139,47,0,OK
15,87.20,98,171,248,63,0,OK
20,90.95,125,286,467,67,0,OK
25,114.60,124,306,458,78,0,힙 경고 (78%)
30,116.65,149,332,449,91,0,힙 위험 (91%)
```
